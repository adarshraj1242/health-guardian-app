<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- PWA Meta Tags -->
    <title>Health Guardian - AI Health Tracker</title>
    <meta name="theme-color" content="#14b8a6"/>
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/192/medical-doctor.png">
    <link rel="manifest" href="data:application/manifest+json;base64,ewogICJuYW1lIjogIkhlYWx0aCBHdWFyZGlhbiIsCiAgInNob3J0X25hbWUiOiAiSGVhbHRoR3VhcmQiLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzBmMTcyYSIsCiAgInRoZW1lX2NvbG9yIjogIiMxNGI4YTYiLAogICJkZXNjcmlwdGlvbiI6ICJZb3VyIHBlcnNvbmFsIEFJIGhlYWx0aCBhbmQgbWVkaWNpbmUgdHJhY2tlci4iLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL2ltZy5pY29uczguY29tL2ZsdWVuY3kvMTkyL21lZGljYWwtZG9jdG9yLnBuZyIsCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIgogICAgfSwKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL2ltZy5pY29uczguY29tL2ZsdWVuY3kvNTEyL21lZGljYWwtZG9jdG9yLnBuZyIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIgogICAgfQogIF0KfQo=">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #1e293b;
        }
        .dark body {
            background-color: #0f172a;
            color: #cbd5e1;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .dark .glass-card {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(51, 65, 85, 0.5);
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="dark">
    <div class="min-h-screen w-full p-4 sm:p-6 lg:p-8">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <header class="flex justify-between items-center mb-8">
                <div class="flex items-center space-x-3">
                    <div class="bg-teal-500 p-2 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-heart-pulse"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/><path d="M3.22 12H9.5l.7-1.5L13.5 14l.5-2H21"/></svg>
                    </div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-slate-800 dark:text-white">Health Guardian</h1>
                </div>
                 <button id="notification-btn" class="flex items-center space-x-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg transition-colors">
                    <i data-lucide="bell-ring"></i>
                    <span class="hidden sm:inline">Notifications On</span>
                </button>
            </header>

            <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <!-- Left Column: Medicine Scheduler -->
                <div class="lg:col-span-2 space-y-8">
                    <div class="glass-card p-6 rounded-2xl shadow-lg">
                        <h2 class="text-xl font-bold mb-4 text-slate-700 dark:text-slate-200">Medicine Schedule</h2>
                        <form id="medicine-form" class="space-y-4">
                            <div>
                                <label for="medicine-name" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Medicine Name</label>
                                <input type="text" id="medicine-name" placeholder="e.g., Paracetamol" class="w-full bg-slate-200 dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-lg p-2 focus:ring-2 focus:ring-teal-500 focus:border-transparent transition">
                            </div>
                            <div>
                                <label for="dosage" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Dosage</label>
                                <input type="text" id="dosage" placeholder="e.g., 1 Tablet" class="w-full bg-slate-200 dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-lg p-2 focus:ring-2 focus:ring-teal-500 focus:border-transparent transition">
                            </div>
                            <div>
                                <label for="time" class="block text-sm font-medium text-slate-600 dark:text-slate-300 mb-1">Time</label>
                                <input type="time" id="time" class="w-full bg-slate-200 dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-lg p-2 focus:ring-2 focus:ring-teal-500 focus:border-transparent transition appearance-none">
                            </div>
                            <button type="submit" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105 flex items-center justify-center space-x-2">
                                <i data-lucide="plus-circle"></i>
                                <span>Add Medicine</span>
                            </button>
                        </form>
                    </div>

                    <div class="glass-card p-6 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-bold mb-4 text-slate-700 dark:text-slate-200">Your Medicines</h3>
                        <div id="medicine-list" class="space-y-3 max-h-60 overflow-y-auto no-scrollbar">
                           <!-- Medicine items will be dynamically added here -->
                           <p id="no-medicine-msg" class="text-slate-500 dark:text-slate-400">You haven't added any medicines yet.</p>
                        </div>
                    </div>
                </div>

                <!-- Right Column: AI Health Assistant -->
                <div class="lg:col-span-3">
                    <div class="glass-card h-full rounded-2xl shadow-lg flex flex-col">
                        <div class="p-4 border-b border-slate-300 dark:border-slate-700 flex items-center space-x-3">
                            <div class="bg-blue-500 p-2 rounded-full">
                                <i data-lucide="bot" class="text-white"></i>
                            </div>
                            <h2 class="text-xl font-bold text-slate-700 dark:text-slate-200">AI Health Assistant</h2>
                        </div>
                        <div id="chat-box" class="flex-1 p-4 overflow-y-auto no-scrollbar">
                             <!-- Chat messages will appear here -->
                             <div class="flex justify-start mb-4">
                                <div class="bg-blue-100 dark:bg-blue-900/50 text-slate-800 dark:text-slate-200 rounded-lg p-3 max-w-sm">
                                    <p>Hello! I'm your AI health assistant. You can ask me about medicines or general health topics.</p>
                                </div>
                            </div>
                        </div>
                        <div id="chat-loading" class="p-4 text-center hidden">
                            <p class="text-slate-500 dark:text-slate-400">Thinking...</p>
                        </div>
                        <div class="p-4 border-t border-slate-300 dark:border-slate-700">
                            <form id="chat-form" class="flex items-center space-x-2">
                                <input type="text" id="chat-input" placeholder="Type your question..." class="flex-1 w-full bg-slate-200 dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition" autocomplete="off">
                                <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white p-3 rounded-lg transition-transform transform hover:scale-110">
                                    <i data-lucide="send"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
        
        // Inline Service Worker Script (Create sw.js file with this content)
        // This is a placeholder. For true offline functionality, this needs a caching strategy.
        /*
        File: sw.js
        self.addEventListener('install', (e) => {
          e.waitUntil(
            caches.open('health-guardian-store').then((cache) => cache.addAll([
              '/',
              '/index.html',
            ])),
          );
        });

        self.addEventListener('fetch', (e) => {
          e.respondWith(
            caches.match(e.request).then((response) => response || fetch(e.request)),
          );
        });
        */
        // Since we can't create a separate sw.js file here, the browser will likely fail to register it.
        // The manifest link is the most crucial part for the "Add to Home Screen" feature.
        // The service worker would be the next step for a more advanced PWA (e.g., for offline mode).

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();

            const medicineForm = document.getElementById('medicine-form');
            const medicineListEl = document.getElementById('medicine-list');
            const noMedicineMsg = document.getElementById('no-medicine-msg');
            
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const chatBox = document.getElementById('chat-box');
            const chatLoading = document.getElementById('chat-loading');
            const notificationBtn = document.getElementById('notification-btn');

            let medicines = JSON.parse(localStorage.getItem('medicines')) || [];
            let chatHistory = [];

            // --- Medicine and Notification Logic ---

            const renderMedicines = () => {
                medicineListEl.innerHTML = '';
                if (medicines.length === 0) {
                    noMedicineMsg.style.display = 'block';
                } else {
                    noMedicineMsg.style.display = 'none';
                    medicines.sort((a,b) => a.time.localeCompare(b.time)).forEach(med => {
                        const medEl = document.createElement('div');
                        medEl.className = 'bg-slate-100 dark:bg-slate-700/50 p-3 rounded-lg flex justify-between items-center';
                        medEl.innerHTML = `
                            <div>
                                <p class="font-semibold text-slate-800 dark:text-slate-100">${med.name}</p>
                                <p class="text-sm text-slate-600 dark:text-slate-300">${med.dosage} - ${formatTime(med.time)}</p>
                            </div>
                            <button data-id="${med.id}" class="delete-btn text-red-500 hover:text-red-700 dark:hover:text-red-400 p-1 rounded-full">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        `;
                        medicineListEl.appendChild(medEl);
                    });
                    lucide.createIcons();
                }
            };
            
            const formatTime = (time) => {
                let [hours, minutes] = time.split(':');
                let ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12; 
                return `${hours}:${minutes} ${ampm}`;
            };

            medicineForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('medicine-name').value.trim();
                const dosage = document.getElementById('dosage').value.trim();
                const time = document.getElementById('time').value;

                if (name && dosage && time) {
                    const newMedicine = {
                        id: Date.now(),
                        name,
                        dosage,
                        time
                    };
                    medicines.push(newMedicine);
                    localStorage.setItem('medicines', JSON.stringify(medicines));
                    renderMedicines();
                    medicineForm.reset();
                } else {
                    alert('Please fill in all the details.');
                }
            });

            medicineListEl.addEventListener('click', (e) => {
                if (e.target.closest('.delete-btn')) {
                    const button = e.target.closest('.delete-btn');
                    const id = button.dataset.id;
                    medicines = medicines.filter(med => med.id != id);
                    localStorage.setItem('medicines', JSON.stringify(medicines));
                    renderMedicines();
                }
            });
            
            const requestNotificationPermission = async () => {
                if (!('Notification' in window)) {
                    alert('This browser does not support desktop notification');
                    return;
                }
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    console.log('Notification permission granted.');
                    notificationBtn.classList.remove('bg-gray-500');
                    notificationBtn.classList.add('bg-blue-500');
                    notificationBtn.querySelector('span').textContent = 'Notifications On';
                } else {
                     notificationBtn.classList.remove('bg-blue-500');
                    notificationBtn.classList.add('bg-gray-500');
                    notificationBtn.querySelector('span').textContent = 'Notifications Off';
                }
            };
            
            notificationBtn.addEventListener('click', requestNotificationPermission);

            const checkReminders = () => {
                const now = new Date();
                const currentTime = now.toTimeString().slice(0, 5); // HH:MM format
                
                medicines.forEach(med => {
                    const medTimeToday = new Date(now.toDateString() + ' ' + med.time);
                    if (med.time === currentTime && !med.notifiedToday) {
                         showNotification(med);
                         // This logic needs improvement to prevent re-notification. 
                         // For a simple prototype, this will notify every minute if the time matches.
                    }
                });
            };

            const showNotification = (med) => {
                if (Notification.permission === 'granted') {
                    const notification = new Notification('Time for your medicine!', {
                        body: `It's time to take your ${med.name} (${med.dosage}).`,
                        icon: 'https://img.icons8.com/color/48/000000/pill.png'
                    });
                }
            };

            // --- AI Chat Logic ---

            const addMessageToChat = (sender, message) => {
                const messageEl = document.createElement('div');
                messageEl.className = `flex mb-4 ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
                
                const messageBubble = document.createElement('div');
                messageBubble.className = `rounded-lg p-3 max-w-md ${sender === 'user' ? 'bg-teal-500 text-white' : 'bg-blue-100 dark:bg-blue-900/50 text-slate-800 dark:text-slate-200'}`;
                messageBubble.textContent = message;
                
                messageEl.appendChild(messageBubble);
                chatBox.appendChild(messageEl);
                chatBox.scrollTop = chatBox.scrollHeight;
            };

            const getAIResponse = async (userMessage) => {
                chatLoading.style.display = 'block';
                chatInput.disabled = true;

                const systemPrompt = "You are an AI Health Assistant. You must provide information about medicines and general health in clear and simple English. Always add a disclaimer that you are not a medical professional and the user should consult a doctor for any medical advice.";

                const apiKey = ""; // API Key will be handled by the environment
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                // Add the new user message to the history for context
                chatHistory.push({ role: "user", parts: [{ text: userMessage }] });

                const payload = {
                    contents: chatHistory,
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API error: ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    const aiText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    if (aiText) {
                         addMessageToChat('assistant', aiText);
                         // Add AI response to history
                         chatHistory.push({ role: "model", parts: [{ text: aiText }] });
                    } else {
                        addMessageToChat('assistant', 'Sorry, I could not find an answer for that.');
                    }
                } catch (error) {
                    console.error('Error fetching AI response:', error);
                    addMessageToChat('assistant', 'An error occurred. Please try again later.');
                } finally {
                    chatLoading.style.display = 'none';
                    chatInput.disabled = false;
                    chatInput.focus();
                }
            };

            chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const userMessage = chatInput.value.trim();
                if (userMessage) {
                    addMessageToChat('user', userMessage);
                    getAIResponse(userMessage);
                    chatInput.value = '';
                }
            });

            // Initial setup
            renderMedicines();
            requestNotificationPermission();
            setInterval(checkReminders, 60000); // Check every minute
        });
    </script>
</body>
</html>

